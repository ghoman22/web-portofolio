name: Deploy to EC2

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
        
    - name: Add EC2 to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
    - name: Deploy to EC2
      run: |
        # Create deployment script
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ðŸš€ Starting deployment..."
        
        # Navigate to project directory or clone if it doesn't exist
        if [ ! -d "/home/${{ secrets.EC2_USER }}/web-portofolio" ]; then
          echo "ðŸ“¦ Cloning repository..."
          cd /home/${{ secrets.EC2_USER }}
          git clone https://github.com/${{ github.repository }}.git web-portofolio
        else
          echo "ðŸ”„ Updating repository..."
          cd /home/${{ secrets.EC2_USER }}/web-portofolio
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}
        fi
        
        cd /home/${{ secrets.EC2_USER }}/web-portofolio
        
        # Make install script executable and run it
        chmod +x install.sh
        sudo ./install.sh
        
        echo "âœ… Deployment completed successfully!"
        EOF
        
        # Copy and execute deployment script on EC2
        scp deploy.sh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/
        ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "chmod +x /tmp/deploy.sh && /tmp/deploy.sh"
        
    - name: Verify deployment
      run: |
        echo "ðŸ” Verifying deployment..."
        # Wait a moment for services to restart
        sleep 10
        
        # Check if site is accessible
        if curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }} | grep -q "200\|301\|302"; then
          echo "âœ… Website is accessible!"
        else
          echo "âŒ Website verification failed"
          exit 1
        fi